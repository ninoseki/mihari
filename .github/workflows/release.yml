name: Release gem

on:
  release:
    types: ["created"]

jobs:
  gem-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up Ruby
        uses: ruby/setup-ruby@44511735964dcb71245e7e55f72539531f7bc0eb # v1.257.0
        with:
          ruby-version: 3.3
          bundler: latest
          bundler-cache: true
      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Configure NPM
        # Disable audit to improve the build performance
        run: npm set audit false
      - uses: rubygems/release-gem@a25424ba2ba8b387abc8ef40807c2c85b96cbe32 # v1.1.1

  image-release:
    runs-on: ubuntu-latest
    needs: gem-release
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Login to GHCR
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Strip v prefix
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: Build Docker image
        run: |
          docker build . \
          --tag "ghcr.io/$GITHUB_ACTOR/mihari:latest" \
          --tag "ghcr.io/$GITHUB_ACTOR/mihari:${{ env.VERSION }}" \
          --build-arg VERSION=${{ env.VERSION }}
      - name: Push Docker image
        run: |
          docker push "ghcr.io/$GITHUB_ACTOR/mihari:latest"
          docker push "ghcr.io/$GITHUB_ACTOR/mihari:${{ env.VERSION }}"
